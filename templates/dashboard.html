<!DOCTYPE html>
<html>
<head>
    <title>Government Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- üîÑ Auto refresh every 5 seconds -->
    <meta http-equiv="refresh" content="5">

    <!-- üîî Notification sound -->
    <audio id="alertSound">
        <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>

    <!-- üîî Notification style -->
    <style>
        #notifyBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 12px 18px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
            z-index: 9999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>

<!-- ‚úÖ SAFE WAY: PASS COUNT USING DATA ATTRIBUTE -->
<body data-alert-count="{{ alerts|length }}">

<!-- üîî Notification box -->
<div id="notifyBox">üö® New Emergency Received!</div>

<h2>üèõ Government Emergency Dashboard</h2>

<table>
<tr>
    <th>Name</th>
    <th>Type</th>
    <th>Emergency Message</th>
    <th>Urgency</th>
    <th>Issue</th>
    <th>People</th>
    <th>Detected Location</th>
    <th>Action Status</th>
    <th>Submitted Time</th>
    <th>Map</th>
    <th>Action</th>
</tr>

{% for a in alerts %}
<tr class="{% if a.status == 'Pending' %}row-pending{% else %}row-approved{% endif %}">
    <td>{{ a.name }}</td>
    <td>{{ a.type }}</td>

    <!-- ONLY translated message -->
    <td>{{ a.translated_message }}</td>

    <td>{{ a.urgency }}</td>
    <td>{{ a.issue_type }}</td>
    <td>{{ a.people_affected }}</td>
    <td>{{ a.text_location }}</td>

    <td class="{% if a.status == 'Pending' %}status-pending{% else %}status-approved{% endif %}">
        {% if a.status == "Pending" %}
            ‚ùå Not Taken
        {% else %}
            ‚úÖ Action Taken
        {% endif %}
    </td>

    <td>{{ a.time }}</td>

    <td>
        <a href="https://www.google.com/maps?q={{a.latitude}},{{a.longitude}}" target="_blank">
            üìç Map
        </a>
    </td>

    <td>
        {% if a.status == "Pending" %}
        <form action="/approve/{{ a.id }}" method="post">
            <!-- hidden field to satisfy backend -->
            <input type="hidden" name="admin_note" value="Action taken">
            <button class="approve-btn" type="submit">Take Action</button>
        </form>
        {% else %}
        ‚úî Done
        {% endif %}
    </td>
</tr>
{% endfor %}
</table>

<!-- üîî SAFE NOTIFICATION SCRIPT -->
<script>
    const currentCount = parseInt(
        document.body.getAttribute("data-alert-count")
    );

    const lastCount = parseInt(
        localStorage.getItem("alertCount")
    );

    if (!isNaN(lastCount) && currentCount > lastCount) {
        const box = document.getElementById("notifyBox");
        box.style.display = "block";
        document.getElementById("alertSound").play();

        setTimeout(() => {
            box.style.display = "none";
        }, 4000);
    }

    localStorage.setItem("alertCount", currentCount);
</script>

</body>
</html>
